import{J as xe,K as Ue,u as De,r as m,g as Ee,b as c,o as r,c as y,d as u,t as _,e as l,w as a,C as Z,E as i,f as d,i as v,F as z,h as x,j as C,T as Se,A as ee,z as $e,y as j,_ as Ae,L as le,M as Ne,l as Oe,N as Be,O as Fe,P as ae,Q as Ie,n as te,m as se,R as Pe,S as Le,U as qe}from"./index-9511e055.js";import{s as Ke,a as je,f as oe,u as Re,d as Je,b as Qe,c as Ye}from"./materials-40f5ef17.js";import{b as We,g as Ge}from"./mindmap-a70de1df.js";import{r as He,A as Xe}from"./activityTracker-6427563e.js";import{a as Ze,r as el,g as ll,b as al}from"./tags-2c6feec3.js";import{_ as tl}from"./_plugin-vue_export-helper-c27b6911.js";import"./storage-02b3d0a9.js";const sl={class:"materials-container"},ol={class:"page-header"},nl={class:"user-info"},ul={class:"search-section"},rl={class:"materials-list"},il={class:"material-info"},dl={class:"material-title"},cl={class:"material-desc"},pl={class:"material-tags"},ml={key:0,class:"hierarchical-tags"},vl={key:1,class:"custom-tags"},fl={class:"material-meta"},_l={class:"custom-tag-input"},gl={key:0,class:"custom-tags-container"},yl={class:"recommended-tags"},hl={class:"recommended-tags-list"},wl={class:"upload-area"},bl={class:"dialog-footer"},Tl={class:"upload-success-content"},kl={class:"mindmap-integration-info"},Cl={key:0},Vl={key:1},Ml={__name:"Materials",setup(zl){const ne=xe({});for(const[s,e]of Object.entries(Ue))ne.component(s,e);const ue=De(),F=m(""),I=m("all"),E=m("newest"),S=m(!1),O=m(!1),P=m(!1),R=m({}),J=m([]),Q=m(""),$=m([]),A=m({role:"管理员",avatar:"A"}),U=m([]),o=m({name:"",description:"",type:"document",file:null,hierarchicalTags:[],customTags:[]}),L=m([]),Y=m([]),V=m(""),re=()=>{const s=ll();L.value=s.map(e=>{const h=al(e);return{value:e,label:e,children:h.map(n=>{const w=Ze(e,n);return{value:n,label:n,children:w.map(p=>({value:p,label:p}))}})}}),Y.value=el},M=m([]),W=()=>{V.value&&V.value.trim()&&(o.value.customTags.includes(V.value.trim())?i.warning("该标签已存在"):(o.value.customTags.push(V.value.trim()),V.value=""))},ie=s=>{o.value.customTags.splice(s,1)},de=s=>{o.value.customTags.includes(s)?i.warning("该标签已存在"):o.value.customTags.push(s)},ce=()=>{S.value=!0,o.value={name:"",description:"",type:"document",file:null,hierarchicalTags:[],customTags:[]},M.value=[],V.value=""},pe=async()=>{if(!o.value.name){i.warning("请输入资料名称");return}if(!o.value.type){i.warning("请选择资料类型");return}if(!M.value||M.value.length===0){i.warning("请选择要上传的文件");return}if(!o.value.hierarchicalTags||o.value.hierarchicalTags.length===0){i.warning("请选择分级标签");return}const s=M.value[0].raw;if(!s){i.error("文件数据无效，请重新选择文件");return}P.value=!0;try{const e=o.value.hierarchicalTags.map(b=>typeof b=="string"?b:JSON.stringify(b)),h={name:o.value.name,description:o.value.description,type:o.value.type,uploader:A.value.role,hierarchicalTags:e,customTags:o.value.customTags};console.log("开始上传文件:",s.name,"类型:",s.type,"大小:",oe(s.size));const n=await Re(h,s);if(!n)throw new Error("上传资料失败：服务器未返回资料信息");const w=await We(n);R.value=n,J.value=w.keywords,Q.value=w.category;try{const{generateMindmapFromTags:b}=await Ae(()=>import("./tagBasedMindmap-6b59b98e.js"),["assets/tagBasedMindmap-6b59b98e.js","assets/mindmap-a70de1df.js","assets/storage-02b3d0a9.js"]);if(n.hierarchicalTags&&n.hierarchicalTags.length>0){const g=n.hierarchicalTags,f=await b(g,[n]);f.isNew?i.success(`已根据标签「${g.join(" > ")}」自动创建思维导图`):i.success(`已将资料添加到「${f.mindmap.title}」思维导图中`),f.mindmap&&!$.value.some(q=>q.id===f.mindmap.id)&&$.value.push(f.mindmap)}}catch(b){console.error("生成标签思维导图出错:",b)}const p=await Ge();$.value=p.filter(b=>b.relatedMaterials.includes(n.id)),i.success("资料上传成功"),S.value=!1,O.value=!0,N()}catch(e){console.error("上传失败:",e);let h="资料上传失败";e.message&&(h+=": "+e.message),i.error(h),M.value=[]}finally{P.value=!1}},me=async s=>{try{await Je(s.id),i.success("下载开始");const e=A.value.username||A.value.role;He(e,Xe.DOWNLOAD,{materialName:s.name,materialId:s.id}),N()}catch(e){console.error("下载失败:",e),i.error("下载失败")}},ve=async s=>{try{const e=await Qe(s.id);i.success(`分享链接已生成: ${e.shareLink}`)}catch(e){console.error("分享失败:",e),i.error("分享失败")}},fe=async s=>{try{await Ye(s.id),i.success("资料已删除"),N()}catch(e){console.error("删除失败:",e),i.error("删除失败")}},G=async()=>{try{const s=await Ke(F.value,I.value);U.value=s}catch(s){console.error("搜索失败:",s),i.error("搜索失败")}},N=async()=>{try{U.value=await je(),E.value==="newest"?U.value.sort((s,e)=>new Date(e.uploadDate)-new Date(s.uploadDate)):E.value==="downloads"?U.value.sort((s,e)=>e.downloads-s.downloads):E.value==="name"&&U.value.sort((s,e)=>s.name.localeCompare(e.name))}catch(s){console.error("加载资料失败:",s),i.error("加载资料失败")}},_e=()=>{N()},ge=(s,e)=>{M.value=e,s&&s.raw&&(o.value.name||(o.value.name=s.name),o.value.file=s.raw)},ye=async s=>{try{const{file:e,onSuccess:h,onError:n}=s;if(e.size>50*1024*1024){i.error("文件大小超过50MB限制"),n("文件大小超过限制");return}const w={document:["application/pdf","application/msword","application/vnd.openxmlformats-officedocument.wordprocessingml.document","text/plain"],image:["image/jpeg","image/png","image/gif","image/svg+xml"],video:["video/mp4","video/webm","video/ogg"],other:[]};return o.value.type!=="other"&&w[o.value.type]&&w[o.value.type].length>0&&!w[o.value.type].includes(e.type)&&i.warning("文件类型与所选资料类型不匹配，请选择正确的资料类型或更换文件"),console.log("文件准备上传:",e.name,"类型:",e.type,"大小:",oe(e.size)),h(e),e}catch(e){console.error("文件处理失败:",e),i.error("文件处理失败: "+(e.message||"未知错误")),s.onError&&s.onError(e)}},he=()=>{i.warning("最多只能上传1个文件")},H=s=>{ue.push({name:"MaterialDetail",params:{id:s.id}})},we=s=>{for(const e of L.value){if(e.value===s)return e.label;if(e.children){for(const h of e.children)if(h.value===s)return h.label}}return s};return Ee(()=>{N(),re()}),(s,e)=>{const h=c("el-avatar"),n=c("el-icon"),w=c("el-input"),p=c("el-option"),b=c("el-select"),g=c("el-button"),f=c("el-tag"),q=c("el-card"),be=c("el-col"),Te=c("el-row"),D=c("el-form-item"),ke=c("el-cascader"),Ce=c("el-upload"),Ve=c("el-form"),X=c("el-dialog"),B=c("el-descriptions-item"),Me=c("el-descriptions"),ze=c("el-result");return r(),y("div",sl,[u("div",ol,[e[14]||(e[14]=u("h1",null,"资料管理",-1)),u("div",nl,[u("span",null,_(A.value.role),1),l(h,{size:40,class:"avatar"},{default:a(()=>[d(_(A.value.avatar),1)]),_:1})])]),u("div",ul,[l(w,{modelValue:F.value,"onUpdate:modelValue":e[0]||(e[0]=t=>F.value=t),placeholder:"搜索资料...",class:"search-input",clearable:"",onKeyup:Z(G,["enter"])},{prefix:a(()=>[l(n,null,{default:a(()=>[l(v(le))]),_:1})]),_:1},8,["modelValue"]),l(b,{modelValue:I.value,"onUpdate:modelValue":e[1]||(e[1]=t=>I.value=t),placeholder:"所有类型",class:"file-type-select"},{default:a(()=>[l(p,{label:"所有类型",value:"all"}),l(p,{label:"文档",value:"document"}),l(p,{label:"图片",value:"image"}),l(p,{label:"视频",value:"video"}),l(p,{label:"其他",value:"other"})]),_:1},8,["modelValue"]),l(b,{modelValue:E.value,"onUpdate:modelValue":e[2]||(e[2]=t=>E.value=t),placeholder:"最新上传",class:"sort-select",onChange:_e},{default:a(()=>[l(p,{label:"最新上传",value:"newest"}),l(p,{label:"最多下载",value:"downloads"}),l(p,{label:"名称排序",value:"name"})]),_:1},8,["modelValue"]),l(g,{type:"primary",onClick:G,class:"search-btn"},{default:a(()=>[l(n,null,{default:a(()=>[l(v(le))]),_:1}),e[15]||(e[15]=d(" 搜索 "))]),_:1}),l(g,{type:"primary",class:"upload-btn",onClick:ce},{default:a(()=>[l(n,null,{default:a(()=>[l(v(Ne))]),_:1}),e[16]||(e[16]=d(" 上传资料 "))]),_:1})]),u("div",rl,[l(Te,{gutter:20},{default:a(()=>[(r(!0),y(z,null,x(U.value,(t,T)=>(r(),C(be,{xs:24,sm:12,md:8,lg:6,key:T},{default:a(()=>[l(Se,{name:"fade-scale",delay:T*50},{default:a(()=>[l(q,{class:"material-item",shadow:"hover",onClick:k=>H(t)},{default:a(()=>[u("div",{class:"material-icon",onClick:e[3]||(e[3]=ee(()=>{},["stop"]))},[u("div",{class:$e(["icon-wrapper",t!=null&&t.type?`${t.type}-bg`:"other-bg"])},[(t==null?void 0:t.type)==="document"?(r(),C(n,{key:0,size:30},{default:a(()=>[l(v(Oe))]),_:1})):(t==null?void 0:t.type)==="image"?(r(),C(n,{key:1,size:30},{default:a(()=>[l(v(Be))]),_:1})):(t==null?void 0:t.type)==="video"?(r(),C(n,{key:2,size:30},{default:a(()=>[l(v(Fe))]),_:1})):(r(),C(n,{key:3,size:30},{default:a(()=>[l(v(ae))]),_:1}))],2)]),u("div",il,[u("h3",dl,_(t.name),1),u("p",cl,_(t.description),1),u("div",pl,[t.hierarchicalTags&&t.hierarchicalTags.length>0?(r(),y("div",ml,[(r(!0),y(z,null,x(t.hierarchicalTags,(k,K)=>(r(),C(f,{key:"h-"+K,size:"small",effect:"plain",class:"tag-item",type:"success"},{default:a(()=>[d(_(we(k)),1)]),_:2},1024))),128))])):j("",!0),t.customTags&&t.customTags.length>0?(r(),y("div",vl,[(r(!0),y(z,null,x(t.customTags,(k,K)=>(r(),C(f,{key:"c-"+K,size:"small",effect:"plain",class:"tag-item",type:"info"},{default:a(()=>[d(_(k),1)]),_:2},1024))),128))])):j("",!0)]),u("div",fl,[l(f,{size:"small",type:"info",effect:"plain",class:"meta-tag"},{default:a(()=>[l(n,null,{default:a(()=>[l(v(Ie))]),_:1}),u("span",null,_(t.uploadDate),1)]),_:2},1024),l(f,{size:"small",type:"success",effect:"plain",class:"meta-tag"},{default:a(()=>[l(n,null,{default:a(()=>[l(v(te))]),_:1}),u("span",null,_(t.downloads)+"次下载",1)]),_:2},1024),l(f,{size:"small",type:"warning",effect:"plain",class:"meta-tag"},{default:a(()=>[l(n,null,{default:a(()=>[l(v(ae))]),_:1}),u("span",null,_(t.size),1)]),_:2},1024),l(f,{size:"small",type:"primary",effect:"plain",class:"meta-tag"},{default:a(()=>[l(n,null,{default:a(()=>[l(v(se))]),_:1}),e[17]||(e[17]=u("span",null,"评论",-1))]),_:1})]),u("div",{class:"material-actions",onClick:e[4]||(e[4]=ee(()=>{},["stop"]))},[l(g,{type:"primary",size:"small",text:"",class:"action-btn",onClick:k=>me(t)},{default:a(()=>[l(n,null,{default:a(()=>[l(v(te))]),_:1}),e[18]||(e[18]=d(" 下载 "))]),_:2},1032,["onClick"]),l(g,{type:"info",size:"small",text:"",class:"action-btn",onClick:k=>ve(t)},{default:a(()=>[l(n,null,{default:a(()=>[l(v(Pe))]),_:1}),e[19]||(e[19]=d(" 分享 "))]),_:2},1032,["onClick"]),l(g,{type:"danger",size:"small",text:"",class:"action-btn",onClick:k=>fe(t)},{default:a(()=>[l(n,null,{default:a(()=>[l(v(Le))]),_:1}),e[20]||(e[20]=d(" 删除 "))]),_:2},1032,["onClick"]),l(g,{type:"success",size:"small",text:"",class:"action-btn",onClick:k=>H(t)},{default:a(()=>[l(n,null,{default:a(()=>[l(v(se))]),_:1}),e[21]||(e[21]=d(" 查看评论 "))]),_:2},1032,["onClick"])])])]),_:2},1032,["onClick"])]),_:2},1032,["delay"])]),_:2},1024))),128))]),_:1})]),l(X,{modelValue:S.value,"onUpdate:modelValue":e[11]||(e[11]=t=>S.value=t),title:"上传资料",width:"500px",class:"upload-dialog","destroy-on-close":""},{footer:a(()=>[u("span",bl,[l(g,{onClick:e[10]||(e[10]=t=>S.value=!1)},{default:a(()=>e[26]||(e[26]=[d("取消")])),_:1}),l(g,{type:"primary",onClick:pe,loading:P.value,class:"submit-btn"},{default:a(()=>e[27]||(e[27]=[d("上传")])),_:1},8,["loading"])])]),default:a(()=>[l(Ve,{model:o.value,"label-width":"80px"},{default:a(()=>[l(D,{label:"资料名称",required:""},{default:a(()=>[l(w,{modelValue:o.value.name,"onUpdate:modelValue":e[5]||(e[5]=t=>o.value.name=t),placeholder:"请输入资料名称"},null,8,["modelValue"])]),_:1}),l(D,{label:"资料描述"},{default:a(()=>[l(w,{modelValue:o.value.description,"onUpdate:modelValue":e[6]||(e[6]=t=>o.value.description=t),type:"textarea",placeholder:"请输入资料描述",rows:"3"},null,8,["modelValue"])]),_:1}),l(D,{label:"分级标签",required:""},{default:a(()=>[l(ke,{modelValue:o.value.hierarchicalTags,"onUpdate:modelValue":e[7]||(e[7]=t=>o.value.hierarchicalTags=t),options:L.value,props:{checkStrictly:!0},clearable:"",placeholder:"请选择分级标签",style:{width:"100%"}},null,8,["modelValue","options"])]),_:1}),l(D,{label:"自定义标签"},{default:a(()=>[u("div",_l,[l(w,{modelValue:V.value,"onUpdate:modelValue":e[8]||(e[8]=t=>V.value=t),placeholder:"输入自定义标签",class:"tag-input",onKeyup:Z(W,["enter"])},{append:a(()=>[l(g,{onClick:W},{default:a(()=>e[22]||(e[22]=[d("添加")])),_:1})]),_:1},8,["modelValue"])]),o.value.customTags&&o.value.customTags.length>0?(r(),y("div",gl,[(r(!0),y(z,null,x(o.value.customTags,(t,T)=>(r(),C(f,{key:T,closable:"",onClose:k=>ie(T),class:"custom-tag-item",type:"info",effect:"plain"},{default:a(()=>[d(_(t),1)]),_:2},1032,["onClose"]))),128))])):j("",!0),u("div",yl,[e[23]||(e[23]=u("div",{class:"recommended-tags-title"},"推荐标签：",-1)),u("div",hl,[(r(!0),y(z,null,x(Y.value,(t,T)=>(r(),C(f,{key:"rec-"+T,onClick:k=>de(t),class:"recommended-tag-item",type:"success",effect:"plain",size:"small"},{default:a(()=>[d(_(t),1)]),_:2},1032,["onClick"]))),128))])])]),_:1}),l(D,{label:"资料类型",required:""},{default:a(()=>[l(b,{modelValue:o.value.type,"onUpdate:modelValue":e[9]||(e[9]=t=>o.value.type=t),placeholder:"请选择资料类型",style:{width:"100%"}},{default:a(()=>[l(p,{label:"文档",value:"document"}),l(p,{label:"图片",value:"image"}),l(p,{label:"视频",value:"video"}),l(p,{label:"其他",value:"other"})]),_:1},8,["modelValue"])]),_:1}),l(D,{label:"上传文件",required:""},{default:a(()=>[l(Ce,{class:"upload-demo",drag:"",action:"#","auto-upload":!1,limit:1,"on-change":ge,"file-list":M.value,"on-exceed":he,"http-request":ye},{tip:a(()=>e[25]||(e[25]=[u("div",{class:"el-upload__tip"},"请上传资料文件，大小不超过50MB",-1)])),default:a(()=>[u("div",wl,[l(n,{class:"el-icon--upload"},{default:a(()=>[l(v(qe))]),_:1}),e[24]||(e[24]=u("div",{class:"el-upload__text"},[d("拖拽文件到此处或 "),u("em",null,"点击上传")],-1))])]),_:1},8,["file-list"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue"]),l(X,{modelValue:O.value,"onUpdate:modelValue":e[13]||(e[13]=t=>O.value=t),title:"上传成功",width:"500px",class:"success-dialog"},{default:a(()=>[u("div",Tl,[l(ze,{icon:"success",title:"资料上传成功","sub-title":"您的资料已成功上传并添加到思维导图搜索引擎"},{extra:a(()=>[u("div",kl,[e[28]||(e[28]=u("h4",null,"思维导图集成信息",-1)),l(Me,{column:1,border:""},{default:a(()=>[l(B,{label:"资料名称"},{default:a(()=>[d(_(R.value.name),1)]),_:1}),l(B,{label:"提取关键词"},{default:a(()=>[(r(!0),y(z,null,x(J.value,(t,T)=>(r(),C(f,{key:T,size:"small",class:"keyword-tag"},{default:a(()=>[d(_(t),1)]),_:2},1024))),128))]),_:1}),l(B,{label:"资料分类"},{default:a(()=>[d(_(Q.value),1)]),_:1}),l(B,{label:"关联思维导图"},{default:a(()=>[$.value.length>0?(r(),y("div",Cl,[(r(!0),y(z,null,x($.value,(t,T)=>(r(),y("div",{key:T,class:"related-mindmap-item"},_(t.title),1))),128))])):(r(),y("div",Vl,"暂无关联思维导图"))]),_:1})]),_:1})])]),actions:a(()=>[l(g,{type:"primary",onClick:e[12]||(e[12]=t=>O.value=!1)},{default:a(()=>e[29]||(e[29]=[d("确定")])),_:1}),l(g,{onClick:s.viewMindmaps},{default:a(()=>e[30]||(e[30]=[d("查看思维导图")])),_:1},8,["onClick"])]),_:1})])]),_:1},8,["modelValue"])])}}},Nl=tl(Ml,[["__scopeId","data-v-a52c921d"]]);export{Nl as default};
